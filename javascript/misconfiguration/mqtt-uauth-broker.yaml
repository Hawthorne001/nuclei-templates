id: unauth-mqtt-broker
info:
  name: MQTT Unauthenticated Broker - Detect
  author: matejsmycka
  severity: high
  description: |
    Detects an unauthenticated MQTT broker and attempts to subscribe to the $SYS/# topic to enumerate broker and system information.
  reference:
    - https://en.wikipedia.org/wiki/MQTT
    - https://github.com/kh4sh3i/MQTT-Pentesting
  metadata:
    verified: true
    max-request: 1
    shodan-query: port:1883 broker
  tags: js,tcp,network,mqtt,unauth

javascript:
  - pre-condition: |
      isPortOpen(Host,Port);

    code: |
      const c = require("nuclei/net");
      const conn = c.Open('tcp', `${Host}:${Port}`, `${Timeout}`);
      let connect_command = "100C00044D5154540402003C0000";
      conn.SendHex(connect_command);

      let subscribe_command = "820b00010006245359532f2300";
      conn.SendHex(subscribe_command);
      let resp = conn.RecvFullString(1024);
      resp;

    args:
      Host: '{{Host}}'
      Port: 1883
      Timeout: 2

    matchers:
      - type: word
        words:
          - "SYS/broker"

    extractors:
      - type: regex
        group: 1
        name: version
        regex:
          - "version ([0-9.]+)"
