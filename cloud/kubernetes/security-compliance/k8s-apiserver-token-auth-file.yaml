id: k8s-apiserver-token-auth-file

info:
  name: Detect kube-apiserver --token-auth-file usage
  author: songyaeji
  severity: high
  description: Detects whether kube-apiserver includes the --token-auth-file startup argument.
  impact: |
    If the API server is started with --token-auth-file, static token file authentication may be allowed, which can enable long-lived or poorly managed tokens and weaken cluster authentication posture.
  remediation: |
    Remove the --token-auth-file argument from the kube-apiserver startup flags (e.g., edit
    /etc/kubernetes/manifests/kube-apiserver.yaml) or ensure any tokens in that file are rotated
    and managed securely. Prefer dynamic, short-lived service account tokens and RBAC.
  reference:
    - https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/
  tags: cloud,devops,kubernetes,security,devsecops,api-server,k8s,k8s-cluster-security

variables:
  argument: "--token-auth-file"

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      kubectl get pods -n kube-system -l component=kube-apiserver -o jsonpath="{.items[*].spec.containers[*].command}"

    matchers-condition: and
    matchers:
      - type: word
        words:
          - 'kube-apiserver'

      - type: word
        words:
          - "{{argument}}"

    extractors:
      - type: dsl
        dsl:
          - '"kube-apiserver is configured with " + argument + ". Review and remove if unnecessary."'
# digest: 4a0a00473045022100f1c8e9a5b6d7c4e3f2a1b0c9d8e7f6a5b4c3d2e1f0a9b8c7d6e5f4a3b2c1d0e9f022041a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2:922c64590222798bb761d5b6d8e72950